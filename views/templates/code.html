{include file="header.html"}

{include file="tipbox.html"}


<script type="text/javascript">
SyntaxHighlighter.all();
var converter = new Showdown.converter();
</script>

<script id="commentTemplate" type="text/html">
{literal}
<div class="inlineComment e${range_text} comment${commentID}" data-range='${range_text}'>
	<span class="hiddenPlainText htext${range_text}" data-range='${range_text}'>${text}</span>
	{{if editable}}
	<a href="javascript:edit(${fileID},'${range_text}',${commentID})"> 
	{{/if}}
		<div class="${range_text} commentbox">
			<span class="inlineCommentText ctext${range_text}">
					{{html formattedText}}
			</span>
			<div class="commentauthor">${commenter}</div>
			<div style="clear:both"></div>
		</div>
	{{if editable}}
	</a>
	{{/if}}
</div>
{/literal}
</script>

<div id="codeheader">
{if $role >= $POSITION_SECTION_LEADER}
<span class="link"><a href="{$course->get_link()}/assignment/{$the_sl->sunetid}/{$assignment}">{$assignment}</a></span>
{else}
{$assignment}
{/if}
:
<span class="link"><a href="{$the_student->get_link()}">{$the_student->display_name}</a></span>

<span class="small-header">Section Leader: {$the_sl->sunetid}</span>


<span class="small-header right hover-underline"><a title="Download code and comments as text file" href="{$root_url}{$class}/download/{$assignment}/{$numbered_submission}/{$assignment}_comments.txt">Download</a></span>
</div>

{if !isset($print_view)}
<div id="filelist">
    {foreach from=$code_files item=info key=file name=codeloop}
    <span class="filelink" data-id='{$smarty.foreach.codeloop.index}'>
	<a href="#" data-name="{$file}" data-id='{$smarty.foreach.codeloop.index}'>
		{$file}
	</a>
	</span>
    {/foreach}

	<div style="clear:both"></div>


<!-- 	{if isset($message)}
	<div id="message">
		{$message}
	</div>
	{/if} -->

</div>

<div style="clear:both"></div>


{/if}

<script type="text/javascript">
{if $role >= $POSITION_SECTION_LEADER and !isset($print_view)}
var interactive = true;
{else}
var interactive = false;
{/if}

    var files = new Array();
	{counter start=0}
    {foreach from=$code_files item=info key=file}
    files[{counter}] = '{$file}';
    {/foreach}
    
    $(document).bind("status.finishedSyntaxHighlighting", function() {
        setupCodeFiles();
    });
    
    // we need to wait for the syntax highlighter to finish before we access the modified dom
    $(document).ready(function(){
       	//setTimeout("setupCodeFiles()", 3000);
	 	$(':checkbox').change(function() {
			release();
		});
    });
    
    function setupCodeFiles(){
		var i = {counter start=0};
        {foreach from=$code_files item=info key=file}
		var cur_file = new CodeFile('{$file}', {counter}, interactive, '{$display_name|escape}');
		code_files.push(cur_file);
		cur_file.setupComments();
    	{/foreach}
		{if isset($print_view)}
			displayAll();
		{else}
			display(0);
		{/if}
		
    }
    
    function hideall(){
    	 for(var i = 0; i < files.length; i++){	 
    		 document.getElementById("file" + i).className = "hidden";
    		 document.getElementById("comments" + i).className = "hidden";
 			$('#fileList'+i).removeClass('selectedFile');
    	 }
    }

    function hideAllComments() {
        $('.inlineComment').hide();
    }

    function displayAllComments() {
        $('.inlineComment').show();
    }

    function displayAll(){
		for(var i = 0; i < code_files.length; i++){
			display(i, false);
		}
    }

    function display(fileNum, hide){
		 if(hide == undefined) hide = true;
	
		 current_file_id = fileNum; //so we know what is currently being viewed
    	 if(hide)
			hideall();
    	 document.getElementById("file" + fileNum).className = "visible";	 
    	 document.getElementById("comments" + fileNum).className = "visible";
		 $('#fileList'+fileNum).addClass('selectedFile');
		 //console.log(code_files[fileNum]);
		if(!code_files[fileNum].displayed)
		   code_files[fileNum].showComments();
    }
    
    function edit(fileID, commentRange, commentID){
    	var file = code_files[fileID];
		var comment = file.getCommentByRangeAndID(commentRange, commentID);
		if(comment) comment.edit();
    }

	function release(){
 		var action = "delete";
		var val = $('input:checkbox:checked').val(); 
 		if(val != undefined){
 		 	action = "create";
 		}
 		$.ajax({
 		   	type: 'POST',
 		   	url: window.location.pathname, // post to current location url
 		   	data: "action=release&release=" + action,
 		   	success: function(response) {
				if(response && response.status == "ok"){
					showSaved();
				}else{
					alert("There was an error in releasing the comments.");
				}
 		   	},
 		   	error: function(XMLHttpRequest, textStatus, errorThrown) {
				alert("There was an error in releasing the comments.");
		   	}
 		 });
 	}

	function resetSaved(){
			$("#saved").addClass("hidden");

	}
	function fade(){	
			$("#saved").fadeOut(400);
			setTimeout("resetSaved()", 500);
	}
	function showSaved(){
			$("#saved").removeClass("hidden");
			$("#saved").css("display", "block");
			setTimeout("fade()", 700);
	}	
</script>

{foreach from=$code_files item=info key=name}
<div id="comments">
	
{if $showComments}
{foreach from=$info.assn->getAssignmentComments() item=comment}
<div id="etop{$comment->getStartLine()}-{$comment->getEndLine()}" class="inlineComment">
<span class="comment hiddenPlainText">{$comment->getCommentText()|stripslashes}</span>
<span class="commenter hiddenPlainText">{$comment->getCommenter()}</span>
</div>
{/foreach}
{/if}

	
</div>
{/foreach}

{if !isset($print_view)}


<div id="rightside">

<!-- <div id="printlink">
	<div class="link smaller"><a href="{$code_file}/print" target="_blank">Print</a></div>
</div> -->

{if $role >= $POSITION_SECTION_LEADER}
<div id="release">
	<form class="link smaller">
	<input type="checkbox" name="release" value="" {if $release}checked{/if} />Release<br />
    <p><a href="javascript: hideAllComments()">Hide comments</a></p>
    <p><a href="javascript: displayAllComments()">Show comments</a></p>
    <p><a href="javascript: showOnlyComments()">Only comments</a></p>
	</form>
</div>

<div id="saved" class="hidden">
	Saved.
</div>

{/if}
</div>
{/if}

{foreach from=$code_files item=info key=file name=codeloop}
<div class="code_container" data-name="{$file}" data-id='{$smarty.foreach.codeloop.index}'>
	<pre class="brush: cpp; gutter: false;">
{$info.contents}
	</pre>
</div>
{/foreach}
